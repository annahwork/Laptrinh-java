<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Staff | Quản lý Khách hàng</title>

    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="app-layout">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>EV Warranty System</h3>

            </div>

            <nav class="sidebar-menu">
                <ul>
                    <li class="menu-group">
                        <button class="menu-group-toggle" type="button">
                            <i class="fas fa-layer-group fa-fw"></i>
                            <span>Quản lý hồ sơ</span>
                            <i class="fas fa-chevron-down group-arrow"></i>
                        </button>
                        <ul class="submenu">
                            <li><a href="vehicles.html"><i class="fas fa-car-side fa-fw"></i> Quản lý Xe</a></li>
                            <li><a href="customers.html" class="active"><i class="fas fa-users fa-fw"></i> Quản lý Khách
                                    hàng
                                </a></li>
                        </ul>
                    </li>

                    <li><a href="claims.html"><i class="fas fa-screwdriver-wrench fa-fw"></i> <span>Yêu cầu Bảo
                                hành</span></a></li>
                    <li><a href="dieu_phoi_ky_thuat_vien.html"><i class="fas fa-user-gear fa-fw"></i> <span>Điều phối Kỹ
                                thuật viên</span></a></li>
                    <li><a href="campaigns.html"><i class="fas fa-bullhorn fa-fw"></i> <span>Quản lý Chiến
                                dịch</span></a></li>
                    <li><a href="notifications.html"><i class="fas fa-bell fa-fw"></i> <span>Thông báo</span></a></li>
                </ul>
            </nav>

            <div class="sidebar-resizer" id="sidebarResizer"></div>
        </aside>

        <main class="content-wrapper" id="contentWrapper">
            <div class="content-header">
                <h1>Quản lý Khách hàng</h1>
            </div>

            <div class="main-content-area">
                <!-- Search + Add -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div style="position:relative; width:320px;">
                        <i class="fas fa-search"
                            style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
                        <input type="text" class="form-control" placeholder="Tìm kiếm theo tên, điện thoại, email..."
                            style="padding-left:40px;">
                    </div>
                    <button class="btn-primary" id="newCustomerBtn"><i class="fas fa-user-plus"></i> Thêm khách hàng
                    </button>
                </div>

                <!-- Filters (ví dụ) - UPDATED: remove source options list, add vehicle type filter -->
                <div class="card" style="margin-bottom:16px;">
                    <div style="padding:12px;">
                        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                            <!-- keep only placeholder for source (no list) -->
                            <select id="sourceFilter"
                                style="padding:8px; border:1px solid var(--border); border-radius:6px;">
                                <option value="">Tất cả nguồn</option>
                            </select>

                            <!-- new: vehicle type filter -->
                            <select id="vehicleTypeFilter"
                                style="padding:8px; border:1px solid var(--border); border-radius:6px;">
                                <option value="">Tất cả loại xe</option>
                                <option value="Sedan">Sedan</option>
                                <option value="SUV">SUV</option>
                                <option value="Hatchback">Hatchback</option>
                                <option value="EV">EV</option>
                                <option value="Pickup">Pickup</option>
                            </select>

                            <select style="padding:8px; border:1px solid var(--border); border-radius:6px;">
                                <option>Sắp xếp</option>
                                <option>Tên A-Z</option>
                                <option>Ngày tạo mới nhất</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Danh sách khách hàng -->
                <div class="card">
                    <div style="padding:14px 18px; border-bottom:1px solid var(--border); background:var(--gray-100);">
                        <h3>Danh sách Khách hàng</h3>
                    </div>
                    <div style="padding:0;">
                        <table class="table-zebra" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:var(--gray-100);">
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Tên</th>
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Điện thoại</th>
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Email</th>
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Địa chỉ</th>
                                    <!-- NEW column: Loại xe -->
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Loại xe</th>
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Số xe</th>
                                    <th style="padding:12px; text-align:left; border-bottom:1px solid var(--border);">
                                        Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="customersTbody">
                                <!-- Placeholder khi chưa có DB -->
                                <tr id="placeholderRow">
                                    <td colspan="7" style="padding:24px; text-align:center; color:var(--text-muted);">
                                        Dữ liệu sẽ được load từ database — chưa có dữ liệu ở môi trường hiện tại.
                                    </td>
                                </tr>

                                <!--
								Ví dụ Thymeleaf khi có backend:
								<tr th:each="cust : ${customers}">
									<td th:text="${cust.fullName}">Nguyễn Văn A</td>
									<td th:text="${cust.phone}">0901234567</td>
									<td th:text="${cust.email}">a@example.com</td>
									<td th:text="${cust.address}">Hà Nội</td>
									<td th:text="${cust.vehicleCount}">2</td>
									<td>
										<button class="btn" onclick="openCustomerPopup(/* pass id */)">Xem</button>
									</td>
								</tr>
								-->
                            </tbody>
                        </table>
                    </div>
                    <div style="padding:12px 18px; border-top:1px solid var(--border); background:var(--gray-100);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--text-muted);">Hiển thị 0 của 0</span>
                            <div>
                                <button
                                    style="padding:6px 10px; margin:0 4px; border:1px solid var(--border); background:white; cursor:pointer;">«
                                    Trước</button>
                                <button class="btn-primary" style="padding:6px 10px; margin:0 4px;">1</button>
                                <button
                                    style="padding:6px 10px; margin:0 4px; border:1px solid var(--border); background:white; cursor:pointer;">2</button>
                                <button
                                    style="padding:6px 10px; margin:0 4px; border:1px solid var(--border); background:white; cursor:pointer;">Sau
                                    »</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer create modal (UPDATED: added vehicle fields) -->
                <div id="customerModal" class="modal" style="display:none;">
                    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="customerModalTitle"
                        tabindex="-1">
                        <div class="modal-header">
                            <h3 id="customerModalTitle">Thêm Khách hàng</h3>
                            <span class="modal-close" id="customerModalClose" role="button"
                                aria-label="Đóng">&times;</span>
                        </div>

                        <form id="customerForm">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Họ và tên</label>
                                    <input type="text" id="c_name" name="fullName" class="form-control" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Điện thoại</label>
                                    <input type="text" id="c_phone" name="phone" class="form-control">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="c_email" name="email" class="form-control">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Địa chỉ</label>
                                    <input type="text" id="c_address" name="address" class="form-control">
                                </div>

                                <!-- NEW: loại xe -->
                                <div class="form-group">
                                    <label class="form-label">Loại xe chính</label>
                                    <select id="c_vehicleType" name="vehicleType" class="form-control"
                                        style="padding:8px; border-radius:6px;">
                                        <option value="">-- Chọn loại xe (tuỳ chọn) --</option>
                                        <option value="Sedan">Sedan</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Hatchback">Hatchback</option>
                                        <option value="EV">EV</option>
                                        <option value="Pickup">Pickup</option>
                                    </select>
                                </div>

                                <!-- NEW: số xe -->
                                <div class="form-group">
                                    <label class="form-label">Số xe</label>
                                    <input type="number" id="c_vehicleCount" name="vehicleCount" class="form-control"
                                        min="0" value="0">
                                </div>

                                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
                                    <button type="button" class="btn" id="customerCancelBtn">Huỷ</button>
                                    <button type="submit" class="btn btn-primary">Lưu</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Customer profile modal skeleton (ẩn, dùng khi có dữ liệu) -->
                <div id="customerModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Profile khách hàng</h3>
                            <span class="modal-close" id="modalClose">&times;</span>
                        </div>
                        <div class="modal-body">
                            <p style="color:var(--text-muted);">Thông tin sẽ load từ DB.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        // Sidebar resize script (giống vehicles.html)
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const contentWrapper = document.getElementById('contentWrapper');
            const resizer = document.getElementById('sidebarResizer');

            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            const minWidth = 200;
            const maxWidth = 400;

            resizer.addEventListener('mousedown', function (e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function (e) {
                if (!isResizing) return;
                const width = startWidth + e.clientX - startX;
                if (width >= minWidth && width <= maxWidth) {
                    sidebar.style.width = width + 'px';
                    contentWrapper.style.marginLeft = width + 'px';
                }
            });

            document.addEventListener('mouseup', function () {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // Modal open/close helpers (skeleton)
            const modal = document.getElementById('customerModal');
            const modalClose = document.getElementById('modalClose');
            window.openCustomerPopup = function () {
                if (modal) modal.style.display = 'block';
            };
            if (modalClose) modalClose.addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

            // Menu group toggle
            const menuGroupToggles = document.querySelectorAll('.menu-group-toggle');
            menuGroupToggles.forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const parentLi = this.parentElement;
                    const isOpen = parentLi.classList.toggle('open');
                    const submenu = this.nextElementSibling;
                    submenu.style.maxHeight = isOpen ? submenu.scrollHeight + 'px' : '0';
                });
            });

            // ---- Customer list client-side (mock) and modal handlers ----
            const customerModal = document.getElementById('customerModal');
            const customerModalClose = document.getElementById('customerModalClose');
            const newCustomerBtn = document.getElementById('newCustomerBtn');
            const customerCancelBtn = document.getElementById('customerCancelBtn');
            const customerForm = document.getElementById('customerForm');
            const cFirst = document.getElementById('c_name');
            const tbody = document.getElementById('customersTbody');
            const placeholder = document.getElementById('placeholderRow');
            const vehicleTypeFilter = document.getElementById('vehicleTypeFilter');

            let customersList = []; // client-side mock store

            function renderCustomers(filterType = '') {
                // clear
                if (!tbody) return;
                tbody.innerHTML = '';
                const list = filterType ? customersList.filter(c => c.vehicleType === filterType) : customersList;
                if (list.length === 0) {
                    tbody.appendChild(placeholder);
                    return;
                }
                list.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
						<td style="padding:12px; border-bottom:1px solid var(--border);">${escapeHtml(c.fullName)}</td>
						<td style="padding:12px; border-bottom:1px solid var(--border);">${escapeHtml(c.phone)}</td>
						<td style="padding:12px; border-bottom:1px solid var(--border);">${escapeHtml(c.email)}</td>
						<td style="padding:12px; border-bottom:1px solid var(--border);">${escapeHtml(c.address)}</td>
						<td style="padding:12px; border-bottom:1px solid var(--border);">${escapeHtml(c.vehicleType || '')}</td>
						<td style="padding:12px; border-bottom:1px solid var(--border); text-align:center;">${c.vehicleCount}</td>
						<td style="padding:12px; border-bottom:1px solid var(--border);">
							<button class="btn" onclick="alert('Xem profile: ${escapeJs(c.fullName)}')">Xem</button>
						</td>
					`;
                    tbody.appendChild(tr);
                });
            }

            // basic XSS-safe helpers
            function escapeHtml(str) {
                if (!str) return '';
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }
            function escapeJs(str) { return escapeHtml(str).replace(/'/g, "\\'"); }

            function openCustomerModal() { if (!customerModal) return; customerModal.style.display = 'block'; document.body.classList.add('modal-open'); setTimeout(() => { if (cFirst) cFirst.focus(); }, 50); }
            function closeCustomerModal() { if (!customerModal) return; customerModal.style.display = 'none'; document.body.classList.remove('modal-open'); if (newCustomerBtn) newCustomerBtn.focus(); }

            if (newCustomerBtn) newCustomerBtn.addEventListener('click', openCustomerModal);
            if (customerModalClose) customerModalClose.addEventListener('click', closeCustomerModal);
            if (customerCancelBtn) customerCancelBtn.addEventListener('click', (e) => { e.preventDefault(); closeCustomerModal(); });
            window.addEventListener('click', (e) => { if (e.target === customerModal) closeCustomerModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && customerModal && customerModal.style.display === 'block') closeCustomerModal(); });

            // filter change
            if (vehicleTypeFilter) {
                vehicleTypeFilter.addEventListener('change', () => renderCustomers(vehicleTypeFilter.value));
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const payload = {
                        fullName: document.getElementById('c_name').value.trim(),
                        phone: document.getElementById('c_phone').value.trim(),
                        email: document.getElementById('c_email').value.trim(),
                        address: document.getElementById('c_address').value.trim(),
                        vehicleType: document.getElementById('c_vehicleType').value,
                        vehicleCount: parseInt(document.getElementById('c_vehicleCount').value || '0', 10)
                    };
                    if (!payload.fullName) { alert('Vui lòng nhập tên.'); return; }

                    // try send to backend; if fails, fallback to local store + render
                    try {
                        const resp = await fetch('/api/customers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (resp.ok) {
                            alert('Thêm khách hàng thành công.');
                            customerForm.reset();
                            closeCustomerModal();
                            // optionally reload from server; for now we push local copy
                            customersList.push(payload);
                            renderCustomers(vehicleTypeFilter.value);
                        } else {
                            let json; try { json = await resp.json() } catch (_) { json = null }
                            alert('Lỗi: ' + (json && json.message ? json.message : resp.status));
                        }
                    } catch (err) {
                        // fallback: local mock
                        console.warn('/api/customers failed, fallback log', err, payload);
                        alert('Chưa có backend. Dữ liệu đã log console và hiển thị tạm.');
                        console.log('NEW CUSTOMER (local):', payload);
                        customersList.push(payload);
                        customerForm.reset();
                        closeCustomerModal();
                        renderCustomers(vehicleTypeFilter.value);
                    }
                });
            }

            // initial render (no data)
            renderCustomers();

            // ...existing code continues...
        });
    </script>

</body>

</html>